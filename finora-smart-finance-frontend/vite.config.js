import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@components': path.resolve(__dirname, './src/components'),
      '@pages': path.resolve(__dirname, './src/pages'),
      '@hooks': path.resolve(__dirname, './src/hooks'),
      '@contexts': path.resolve(__dirname, './src/contexts'),
      '@services': path.resolve(__dirname, './src/services'),
      '@utils': path.resolve(__dirname, './src/utils'),
      '@styles': path.resolve(__dirname, './src/styles'),
    },
  },
  css: {
    modules: {
      // Verwende immer eindeutige Klassennamen, um Kollisionen zwischen Modulen (z.B. mehrere "header") zu vermeiden.
      generateScopedName: process.env.NODE_ENV === 'production'
        ? '[hash:base64:5]'
        : '[name]__[local]__[hash:base64:5]',
      
      // Klassennamen in camelCase umwandeln
      localsConvention: 'camelCaseOnly',
    },
    preprocessorOptions: {
      scss: {
        api: 'modern-compiler',
        additionalData: `
          @use "@styles/variables.scss" as *;
          @use "@styles/mixins.scss" as *;
        `,
      },
    },
  },
  server: {
    host: true,
    port: 3000,
    strictPort: false,
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:5000',
        changeOrigin: true,
        secure: false,
        // Ensure headers are properly forwarded
        headers: {
          Connection: 'keep-alive',
        },
        configure: (proxy) => {
          proxy.on('error', (err, req) => {
            console.error('[Proxy Error]', err.message, req.url);
          });
          proxy.on('proxyReq', (proxyReq, req) => {
            console.log('[Proxy →]', req.method, req.url, 'from:', req.headers.origin || req.headers.host);
          });
          proxy.on('proxyRes', (proxyRes, req) => {
            console.log('[Proxy ←]', proxyRes.statusCode, req.url);
          });
        },
      },
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: true,
    chunkSizeWarningLimit: 700,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom', 'react-router-dom'],
          axios: ['axios'],
          motion: ['framer-motion'],
          charts: ['recharts'],
          query: ['@tanstack/react-query'],
          icons: ['react-icons/fi'],
        },
      },
    },
  },
  // ============================================
  // VITEST CONFIGURATION
  // ============================================
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.js',
    include: ['src/**/*.{test,spec}.{js,jsx}'],
    exclude: ['node_modules', 'dist'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.js',
        '**/index.js',
      ],
    },
  },
});
